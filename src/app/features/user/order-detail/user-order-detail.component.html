<div class="min-h-screen pt-8 pb-24 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <app-ui-container customClass="p-8">
        <div class="mb-6">
            <a routerLink="/user/orders" class="text-gray-400 hover:text-white flex items-center gap-1 mb-4">
                <span class="material-icons text-sm">arrow_back</span> Back to Orders
            </a>

            @if (order()) {
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">Order #{{ order()!.id.slice(0, 8) }}</h1>
                    <div class="flex gap-3">
                        <span class="text-sm bg-white/10 px-2 py-1 rounded text-white">Payment: {{
                            order()!.paymentStatus }}</span>
                    </div>
                </div>
            </div>

            <!-- Items Section -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Items</h2>
                    @if (isEditable()) {
                    <app-ui-btn variant="secondary" size="sm" (click)="navigateToProject()">
                        Edit Items
                    </app-ui-btn>
                    } @else {
                    <span class="bg-gray-800 text-gray-400 px-3 py-1 rounded text-xs border border-gray-700">Order
                        Locked</span>
                    }
                </div>

                <div class="space-y-4">
                    @for (item of currentItems(); track item.productId + item.specId) {
                    <div class="flex items-center justify-between p-4 rounded bg-white/5 border border-white/10">
                        <div>
                            <div class="text-white font-medium">{{ item.productName }}</div>
                            <div class="text-sm text-gray-400">{{ item.specName }}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-white">{{ item.price | number }}</div>

                            @if (isEditingItems()) {
                            <div class="flex items-center gap-2">
                                <button (click)="updateQuantity(item, -1)"
                                    class="p-1 hover:bg-white/10 rounded text-gray-400">-</button>
                                <span class="w-8 text-center text-white">{{ item.quantity }}</span>
                                <button (click)="updateQuantity(item, 1)"
                                    class="p-1 hover:bg-white/10 rounded text-gray-400">+</button>
                            </div>
                            } @else {
                            <div class="text-gray-400">Qty: {{ item.quantity }}</div>
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>

            <!-- Note Section -->
            <div class="mt-6 bg-white/5 p-4 rounded border border-white/10">
                <div class="text-sm font-semibold text-gray-400 mb-2">Order Notes</div>
                @if (isEditingItems()) {
                <textarea [(ngModel)]="note" rows="3"
                    class="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-white focus:border-blue-500 focus:outline-none"
                    placeholder="Add a note..."></textarea>
                } @else {
                <div class="text-white whitespace-pre-wrap">{{ note || 'No notes provided.' }}</div>
                }
            </div>


            <!-- Summary Section -->
            <div class="mt-4 pt-4 border-t border-white/10 flex flex-col items-end gap-2">
                <div class="flex justify-between w-full sm:w-64 text-gray-400">
                    <span>Subtotal</span>
                    <span>\${{ subtotal() | number }}</span>
                </div>
                <div class="flex justify-between w-full sm:w-64 text-gray-400">
                    <span>Shipping Fee</span>
                    <span>\${{ shippingFee() | number }}</span>
                </div>
                <div
                    class="flex justify-between w-full sm:w-64 text-xl font-bold text-white mt-2 pt-2 border-t border-white/10">
                    <span>Total</span>
                    <span>\${{ total() | number }}</span>
                </div>
            </div>

            <!-- Payment Section -->
            <div class="mt-8 pt-8 border-t border-white/10">
                <h2 class="text-xl font-semibold text-white mb-4">Payment Information</h2>

                @if (isEditingPayment()) {
                <div class="space-y-4 max-w-md">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Payment Method</label>
                        <select [(ngModel)]="paymentMethod"
                            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-white [color-scheme:dark]">
                            <option value="" class="bg-[#1a1a1a]">Select Method</option>
                            <option value="Cash" class="bg-[#1a1a1a]">Cash</option>
                            <option value="Transfer" class="bg-[#1a1a1a]">Transfer</option>
                        </select>
                    </div>

                    @if (paymentMethod === 'Transfer') {
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Account Last 5 Digits</label>
                        <input type="text" [(ngModel)]="accountLast5" maxlength="5"
                            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-white"
                            placeholder="12345">
                    </div>
                    }

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Amount Paid</label>
                        <input type="number" [(ngModel)]="paymentAmount"
                            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-white"
                            placeholder="0.00">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Date Paid</label>
                        <input type="datetime-local" [(ngModel)]="paymentPaidAt"
                            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-white text-gray-400-placeholder [color-scheme:dark]">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Shipping Address</label>
                        <textarea [(ngModel)]="shippingAddress" rows="2"
                            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-white"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Contact Info</label>
                        <input type="text" [(ngModel)]="contactInfo"
                            class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-white">
                    </div>
                    <div class="flex gap-2 pt-2">
                        <app-ui-btn variant="ghost" size="sm" (click)="cancelEditPayment()">Cancel</app-ui-btn>
                        <app-ui-btn variant="primary" size="sm" (click)="savePayment()"
                            [loading]="groupBuyService.updatingOrder()">
                            Submit Payment Info
                        </app-ui-btn>
                    </div>
                </div>
                } @else {
                <div class="bg-white/5 p-4 rounded border border-white/10">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-400 block">Method</span>
                            <span class="text-white">{{ order()!.paymentInfo?.method || 'Not Set' }}</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400 block">Amount</span>
                            <span class="text-white">\${{ (order()!.paymentInfo?.amount?.toString() || '0') | number
                                }}</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400 block">Last 5 Digits</span>
                            <span class="text-white">{{ order()!.paymentInfo?.accountLast5 || 'Not Set' }}</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400 block">Paid At</span>
                            <span class="text-white">{{ order()!.paymentInfo?.paidAt ?
                                (order()!.paymentInfo?.paidAt?.toDate() | date:'medium') : 'Not Paid' }}</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        @if (isEditable()) {
                        <app-ui-btn variant="secondary" size="sm" (click)="toggleEditPayment()">Update Payment
                            Info</app-ui-btn>
                        } @else {
                        <span class="text-xs text-gray-500 italic">Modifications locked.</span>
                        }
                    </div>
                </div>
                }
            </div>

            @if (groupBuyService.updateOrderError()) {
            <div class="mt-4 p-4 bg-red-500/10 border border-red-500/20 text-red-400 rounded">
                {{ groupBuyService.updateOrderError() }}
            </div>
            }

            } @else if (groupBuyService.loadingMyOrders()) {
            <div class="text-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <div class="text-gray-400">Loading order details...</div>
            </div>
            } @else {
            <div class="text-center py-12">
                <div class="bg-red-500/10 border border-red-500/20 text-red-400 p-6 rounded-lg max-w-md mx-auto">
                    <h3 class="text-lg font-bold mb-2">Order Not Found</h3>
                    <p class="mb-4 text-sm text-red-300">The order you are looking for does not exist or you do not have
                        permission to view it.</p>
                    <a routerLink="/user/orders">
                        <app-ui-btn variant="outline" size="sm">Back to My Orders</app-ui-btn>
                    </a>
                </div>
            </div>
            }
        </div>
    </app-ui-container>
</div>