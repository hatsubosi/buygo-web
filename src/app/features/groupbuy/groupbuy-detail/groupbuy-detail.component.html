<div class="relative min-h-screen pb-24">
  <!-- Loading State -->
  @if (groupBuyService.isLoadingDetail()) {
    <div class="flex h-screen items-center justify-center">
      <span
        class="h-10 w-10 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"
      ></span>
    </div>
  }

  @if (groupBuyService.currentGroupBuy(); as project) {
    <!-- Hero Section -->
    <div class="relative h-[40vh] w-full overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-b from-transparent to-[#0a0a0a] z-10"></div>
      <div
        class="absolute inset-0 bg-gradient-to-br from-blue-900/40 to-purple-900/40 opacity-70"
      ></div>
      <!-- Cover Image -->
      @if (project.coverImageUrl) {
        <img
          [src]="project.coverImageUrl"
          class="absolute inset-0 h-full w-full object-cover opacity-60"
          alt="Project Cover"
        />
      } @else {
        <div class="absolute inset-0 bg-gray-900"></div>
      }

      <div class="relative z-20 flex h-full flex-col justify-end px-4 pb-12 sm:px-8">
        <h1 class="text-4xl font-bold text-white md:text-6xl">{{ project.title }}</h1>
        <p class="mt-4 max-w-2xl text-lg text-gray-300">{{ project.description }}</p>
      </div>

      <!-- Manager Actions -->
      @if (canManage()) {
        <div class="absolute top-24 right-4 sm:right-8 z-30">
          <a routerLink="/manager">
            <app-ui-btn
              variant="outline"
              customClass="!bg-black/50 backdrop-blur-md !border-white/20 hover:!bg-white/10"
            >
              <span class="material-icons text-sm mr-2">settings</span>
              Manage Project
            </app-ui-btn>
          </a>
        </div>
      }
    </div>

    <!-- Content -->
    <div class="px-4 sm:px-8">
      <app-ui-container>
        <div class="p-6">
          <h2 class="text-2xl font-bold text-white mb-6">Products</h2>

          <div class="space-y-4">
            @if (groupBuyService.currentProducts().length === 0) {
              <div
                class="rounded-xl border border-white/10 bg-white/5 p-8 text-center text-gray-400"
              >
                No products available yet.
              </div>
            }

            <!-- Product List -->
            @for (product of groupBuyService.currentProducts(); track product.id) {
              <div
                class="flex flex-col sm:flex-row gap-4 rounded-xl bg-white/5 p-4 border border-white/10 hover:border-white/20 transition-all"
              >
                <!-- Image -->
                <div
                  class="h-32 w-full sm:w-32 rounded-lg bg-gray-800 flex-shrink-0 relative overflow-hidden"
                >
                  @if (product.imageUrl) {
                    <img [src]="product.imageUrl" class="h-full w-full object-cover" />
                  }
                  @if (!product.imageUrl) {
                    <div class="h-full w-full flex items-center justify-center text-gray-600">
                      No Image
                    </div>
                  }
                </div>

                <!-- Details -->
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-white">{{ product.name }}</h3>
                  <p class="text-sm text-gray-400 mb-2">{{ product.description }}</p>
                  <div class="flex items-baseline gap-2 mb-3">
                    <span class="text-xl font-bold text-blue-400"
                      >NT$ {{ product.priceFinal }}</span
                    >
                    @if (product.priceOriginal > 0 && product.exchangeRate !== 1) {
                      <span class="text-xs text-gray-400">
                        from {{ project.sourceCurrency || 'JPY' | currencySymbol }}
                        {{ product.priceOriginal }}
                      </span>
                    }
                  </div>

                  <!-- Spec Selection -->
                  @if (product.specs.length > 0) {
                    <div class="mb-3 max-w-[200px]">
                      <label class="block text-xs text-gray-400 mb-1">Variation</label>
                      <select
                        class="w-full bg-gray-900 text-white text-sm rounded border border-gray-700 p-2 focus:border-blue-500 outline-none"
                        (change)="onSpecSelect(product.id, $event)"
                      >
                        @for (spec of product.specs; track spec.id) {
                          <option [value]="spec.id">
                            {{ spec.name }}
                          </option>
                        }
                      </select>
                    </div>
                  }
                </div>

                <!-- Actions (Specs & Add) -->
                <div class="flex flex-col gap-3 min-w-[140px] justify-center">
                  <!-- Add Button -->
                  <!-- Add Button / Stepper -->
                  @if (!isOrderSubmittedOrConfirmed() || isEditing) {
                    <ng-container>
                      @if (getQuantity(product) === 0) {
                        <app-ui-btn variant="outline" (onClick)="updateProductQuantity(product, 1)">
                          Add to Order
                        </app-ui-btn>
                      }

                      @if (getQuantity(product) > 0) {
                        <div
                          class="flex items-center justify-between rounded-lg bg-white/10 p-1 border border-white/20 w-full max-w-[140px]"
                        >
                          <button
                            class="w-8 h-8 flex items-center justify-center rounded bg-transparent hover:bg-white/10 text-white transition-colors"
                            (click)="updateProductQuantity(product, -1)"
                          >
                            <span class="material-icons text-sm">remove</span>
                          </button>
                          <span class="text-white font-medium">{{ getQuantity(product) }}</span>
                          <button
                            class="w-8 h-8 flex items-center justify-center rounded bg-transparent hover:bg-white/10 text-white transition-colors"
                            (click)="updateProductQuantity(product, 1)"
                          >
                            <span class="material-icons text-sm">add</span>
                          </button>
                        </div>
                      }
                    </ng-container>
                  }

                  @if (isOrderSubmittedOrConfirmed() && !isEditing) {
                    <ng-container>
                      <span class="text-xs text-gray-500 text-center block"> Order Placed </span>
                    </ng-container>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </app-ui-container>
    </div>

    <!-- Bottom Action Bar -->
    @if (groupBuyService.cartCount() > 0 || isOrderSubmittedOrConfirmed()) {
      <div
        class="fixed bottom-0 left-0 right-0 z-50 border-t border-white/10 bg-[#0a0a0a]/90 p-4 backdrop-blur-xl animate-invoke"
      >
        <div class="mx-auto flex max-w-4xl items-center justify-between">
          <!-- State 1: Active Ordering / Editing -->
          @if (!isOrderSubmittedOrConfirmed() || isEditing) {
            <ng-container>
              <div class="flex items-center gap-4">
                <div
                  class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-600 text-white font-bold"
                >
                  {{ groupBuyService.cartCount() }}
                </div>
                <div class="flex flex-col">
                  <span class="text-xs text-gray-400">Total Estimated</span>
                  <span class="text-xl font-bold text-white"
                    >NT$ {{ groupBuyService.cartTotal() }}</span
                  >
                </div>
              </div>
              <div class="flex gap-2">
                @if (isEditing) {
                  <app-ui-btn variant="ghost" (onClick)="cancelEdit()"> Cancel </app-ui-btn>
                }
                <app-ui-btn variant="primary" (onClick)="goToCheckout(project.id)">
                  Review Order
                </app-ui-btn>
              </div>
            </ng-container>
          }

          <!-- State 2: Order Placed (View Mode) -->
          @if (isOrderSubmittedOrConfirmed() && !isEditing) {
            <ng-container>
              <div class="flex items-center gap-4">
                <div
                  class="flex h-10 w-10 items-center justify-center rounded-full bg-green-600 text-white font-bold"
                >
                  <span class="material-icons text-sm">check</span>
                </div>
                <div class="flex flex-col">
                  <span class="text-xs text-green-400">Order Placed</span>
                  <!-- Show Order Total if available -->
                  @if (existingOrder(); as order) {
                    <span class="text-xl font-bold text-white"> NT$ {{ order.totalAmount }} </span>
                  }
                </div>
              </div>
              <div class="flex gap-2">
                @if (!isOrderLocked()) {
                  <app-ui-btn variant="outline" (onClick)="editOrder()"> Edit Order </app-ui-btn>
                }
                @if (isOrderLocked()) {
                  <span class="text-xs text-gray-500 italic px-3 flex items-center"
                    >Order Locked</span
                  >
                }
                <app-ui-btn variant="primary" (onClick)="viewOrder()"> View Order </app-ui-btn>
              </div>
            </ng-container>
          }
        </div>
      </div>
    }
  }
</div>
